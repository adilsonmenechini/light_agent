import json
import re
from pathlib import Path
from datetime import datetime

def migrate():
    memory_dir = Path("workspace/memory")
    md_files = list(memory_dir.glob("*.md"))
    
    for md_file in md_files:
        if md_file.name == "memory.md" or md_file.name == "MEMORY.md":
            continue
            
        print(f"Migrating {md_file.name}...")
        content = md_file.read_text(encoding="utf-8")
        
        # Split by ### timestamp
        blocks = re.split(r'### (\d{2}:\d{2}:\d{2})', content)
        # blocks[0] is header, [1] is ts, [2] is content, [3] is ts, [4] is content...
        
        entries = []
        current_entry = {}
        
        for i in range(1, len(blocks), 2):
            ts = blocks[i]
            block_content = blocks[i+1].strip()
            
            if block_content.startswith("User:"):
                # If we had a previous conversation, save it
                if current_entry:
                    entries.append(current_entry)
                
                current_entry = {
                    "timestamp": ts,
                    "conversation_id": "legacy",
                    "question": block_content.replace("User:", "").strip(),
                    "answer": "",
                    "summary": "Legacy memory entry",
                    "content": block_content
                }
            elif block_content.startswith("Assistant:") or block_content.startswith("Tool Result"):
                if current_entry:
                    current_entry["answer"] += "\n" + block_content
                    current_entry["content"] += "\n\n" + block_content
                else:
                    # Orphan assistant/tool block
                    entries.append({
                        "timestamp": ts,
                        "conversation_id": "legacy",
                        "content": block_content
                    })
        
        if current_entry:
            entries.append(current_entry)
            
        json_file = md_file.with_suffix(".json")
        with open(json_file, "w", encoding="utf-8") as f:
            json.dump(entries, f, indent=2, ensure_ascii=False)
        print(f"Created {json_file.name}")

if __name__ == "__main__":
    migrate()
